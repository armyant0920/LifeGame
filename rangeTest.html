<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="stylesheet" href="style/panel.css">
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Range test</title>
    <style>
        .available {

            -webkit-animation: available 1s infinite;
        }

        @-webkit-keyframes available {
            0% {
                background-color: blue;
                opacity: 0.8;
            }

            100% {
                background-color: blue;
                opacity: 0.5;
            }


        }

        .icon {
            position: absolute;
            width: auto;
            height: 100%;
            opacity: 1;

        }

        .chess {
            width: 100%;
            height: 100%;
        }

        td {
            width: 32px;
            height: 32px;
        }
    </style>



    <script src="../js/jquery.js"></script>
</head>

<body>


    <div style="text-align: center;">

        <table id='mytable' style="background-image: url('images/background1.jpg'); background-repeat: no-repeat;background-size: cover;">

        </table>
        <div style="-webkit-animation:available ;"></div>


        <div id='hint' onmouseover="showThis(this);" onmouseout="hideThis(this);"
            style="width:auto;height:auto;border:solid 1px #a1bece;position:absolute;z-index:10000;display:none;background-color:#EEF7EA;font-size: large;">
            <p></p>
        </div>

        <div id='menu' onmouseover="showThis(this);" onmouseout="hideThis(this);" #575856
            style="width:300px;height:150px;border:solid 1px #a1bece;position:absolute;z-index:10000;display:none;background-color:rgba( 87, 88, 86, 0.5);font-size: large;float: left;">
            <div style="float: left;">
                <span>desc</span>
                <button id='move' onclick="rangeCheck(pickBlock);">移動</button>
                <button id='skill' onclick="">技能</button>
                <button id='item' onclick="">道具</button>
                <button id='state' onclick="">狀態</button>
            </div>

            <img id='icon' class='icon' style="position: relative;float: right;">
            <!--style="position: absolute;"-->
        </div>
        <div class='available' style='width:200px;height: 200px;'>123456
            <img src="images/effect/jV095BV.gif">
        </div>


    </div>
    <script>


        //人物圖片設定
        var source = document.createElement("img");
        source.src = "images/role.png";

        //右鍵事件設定
        document.oncontextmenu = function (e) {

            //需取得右鍵點下的位置,是不是一個可以被移動到的格子


            return false; //很重要，不能讓瀏覽器顯示自己的右鍵選單
        }



        var playing = false;
        var range = [];
        var chessmen = [];

        var Timer = null;
        


        var activate = false;//滑鼠是否啟動
        var pickBlock;
        var records = [];

        var up = -4, left = -4, right = 4, button = 4;



        //重置計時器
        function resetTimer() {
            if (Timer != null) {
                window.clearInterval(Timer);

            }
            Timer = setInterval(play, speed);

        }

        $(document).on('mouseover', '.block', function () {

            showHint(this);

        })

        //格子 點擊事件
        $(document).on('mousedown', '.block', function (e) {
            //左鍵
            if (e.button == 0) {
                pickBlock = $(this);
                console.log('pcik=' + pickBlock.attr('pos'));
                //如果是一個棋子
                if (pickBlock.attr("chess") == 'Y') {
                    //切換啟動狀態
                    activate = !activate;
                   // rangeCheck(pickBlock);
                    console.log('activate=' + activate);
                    showMenu($(this));
                }


            }

            //右鍵

            if (e.button == 2) {
                let pos = $(this).attr('pos');
                pos='\"'+pos+'\"';
                console.log(`你點了右鍵:${pos} `);
                console.log("id=" + pickBlock.attr('chessId'));
                if ($(this).attr('block') != 'Y') {

                    chessmen.forEach(function (id, index, arr) {
                    console.log(`比對中:${arr[index].id}`);
                    if (arr[index].id == pickBlock.attr('chessId')) {

                        //let e=document.getElementById(temp.name);
                        // e.remove();
                        console.log('比對OK');
                        arr[index].move(pos);
                        //document.body.remove(this.mDiv);
                    }
                });


                    $.each(range, function (index, block) {
                        range[index].removeClass('available');
                        range[index].css("background-color", "");




                    });

                    activate = false;


                }
    
                //以陣列統一控管格子
               /* $.each(range, function (index, block) {

                    if (range[index].attr('block') == 'Y') {
                        range[index].css("background-color", "black");

                    } else {
                        range[index].addClass('available');

                    }

                })*/


               
                //$(this).append("<img id='" + tempPos + "' class='chess'  src='images/waifu_1.png'>");

            }



            if (e.button == 1) {
                console.log("你點了滾輪");
            }



        });

        function showMenu(obj){
            console.log('showMenu');
            let top = $(obj).offset().top;
            let left = $(obj).offset().left + $(obj).width() * 2;

            $("#menu").css({ 'top': top + "px", 'left': (left+100) + "px" }).show("fast");
            let img = document.getElementById('icon');
            img.src = 'images/waifu_1.png';


        }




        function showHint(obj) {
            console.log('showhint')
            var top = $(obj).offset().top;
            var left = $(obj).offset().left + $(obj).width() * 2;
            // $('hint').children('p').text($(obj).attr('pos'));

            document.getElementById('hint').innerHTML = $(obj).attr('pos');

            //console.log('pos=' + $(obj).attr('pos'));
            $("#hint").css({ 'top': top + "px", 'left': left + "px" }).show("fast");
         

        }

        function showThis(obj) {
            $(obj).show();
        }
        /*隱藏浮動框*/
        function hideHint() {
            $("#editCourseDiv").hide();
        }
        function hideThis(obj) {
            $(obj).hide();
        }



        function init() {

            // Timer = setInterval(play, speed);

            let tableStr = "";

            rendTable();



        }
        init();

        function rendTable() {

         

            let tableStr = "";

            $('#mytable').empty();
            for (let y = up; y <= button; y++) {
                tableStr += "<tr>";
                for (let x = left; x <= right; x++) {

                    tempPos = "\"X:" + x + "|Y:" + y + "\"";
            
                    tableStr += "<td class='block' pos=" + tempPos + " pick='false'></td>";

                }
                tableStr += "</tr>";


            }

            records.push(tableStr);//如果只需要繪表,也許存字串就夠了?

            $('#mytable').append(tableStr);


        }





        function rangeCheck(b) {
            //不確定是不是最好的清空法..
            range = [];
            console.log("b="+b.attr('pos'));

            $('.block').css("background-color", "");
            pickBlock.css("background-color", "red");
            let pos = b.attr('pos');
            let posX = parseInt(pos.slice(pos.indexOf('X:') + 2, pos.indexOf('|')));
            let posY = parseInt(pos.slice(pos.indexOf('Y:') + 2));

            let yStart = -3, yEnd = 3;
            let xStart = -3, xEnd = 3;
            let count = 0;//基準點周圍格子判斷計數


            // console.log('@xstart=' + xStart);
            // console.log('@xend=' + xEnd);
            // console.log('@ystart=' + yStart);
            // console.log('@yend=' + yEnd);

            //方向:從上到下,從左至右    
            //for (let i = posX + xStart; i <= posX + xEnd; i++) 
            for (let i = xStart; i <= xEnd; i++) {


                //for (let j = posY + yStart; j <= posY + yEnd; j++) 
                for (let j = yStart + Math.abs(i); j <= yEnd - Math.abs(i); j++) {

                    let current = "\"X:" + (i + posX) + "|Y:" + (j + posY) + "\"";
                   // console.log(`current=${current}`);

                    let temp = $('td[pos=' + current + ']');


                    //判斷temp格子是否已存在,以及是否是正在檢查的格子
                    if (temp != null && temp.attr('pos') != b.attr('pos')) {
                        range.push(temp);
                        /* if (temp.attr('block') == 'Y') {
                             temp.css("background-color", "black");
                         } else {
                             temp.addClass('available');
                             //temp.css("background-color", "lightblue");
                         }*/

                    } else {

                       //console.log(`不符條件:${temp.attr('pos')}`);
                        continue;
                    }



                }
            }

            //以陣列統一控管格子
            $.each(range, function (index, block) {

                if (range[index].attr('block') == 'Y') {
                    range[index].css("background-color", "black");

                } else {
                    range[index].addClass('available');

                }

            })


        }

        class chess {
            id;
            posX;
            posY;
            position;
            block;
            color;

            move(pos) {

                //let temp = $('td[pos=' + current + ']');
                console.log("舊位置" + this.position);
               
                let temp = $('td[pos=' + this.position + ']');
                if (temp != null) {

                    temp.css("background-color", "");
                    temp.attr('chess', "N");
                    temp.attr('block', "");
                    temp.empty();
                    //temp.remove(".chess");



                }
                console.log("新位置:" + pos);
                temp = $('td[pos=' + pos + ']');
                //pos='\"+'+pos+'\"';
                 if(temp!=null){


                    temp.css("background-color", this.color);
                    temp.attr('chess', "Y");
                    temp.attr('block', this.block);
                    temp.attr('chessId', this.id);

                    temp.append("<img id='" + this.id + "'pos='"+pos+"' class='chess'  src='images/waifu_1.png'>");              
                }

                this.position=pos;



            }
            constructor(id, posX, posY, block, color) {
                this.id = id;
                this.posX = posX;
                this.posY = posY
                this.block = block;
                this.color = color;
                console.log(`create:posX:${posX} posY:${posY} block:${block} color:${color}`);
                // $(body).append('<div></div>');
                let current = "\"X:" + posX + "|Y:" + posY + "\"";
                this.position = current;
                console.log(`current=${current}`);

                let temp = $('td[pos=' + current + ']');

                if (temp != null) {

                    temp.css("background-color", color);
                    temp.attr('chess', "Y");
                    temp.attr('chessId', id);
                    temp.attr('block', block);

                    temp.append("<img id='" + id + "' pos='" + tempPos + "' class='chess'  src='images/waifu_1.png'>");



                } else {

                }

                chessmen.push(this);





            }



        }



    </script>

</body>

</html>